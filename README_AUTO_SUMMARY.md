# מערכת הסיכום האוטומטי - Auto Summary System

## 🎯 מטרה
מערכת זו מבצעת סיכום אוטומטי של שיחות WhatsApp שלא קיבלו סיכום, גם אם הלקוח לא כתב "ביי" או מילות סיום אחרות.

## ⚡ איך זה עובד

### 1. **זיהוי שיחות ישנות**
- המערכת בודקת כל 5 דקות את כל השיחות הפעילות
- מזהה שיחות שעברו יותר משעה מההודעה האחרונה
- בודקת שיש לפחות 5 הודעות בשיחה (שיחה משמעותית)

### 2. **סיכום אוטומטי**
- מבצעת סיכום אוטומטי לשיחות ישנות
- שומרת את הסיכום בקובץ הטקסט
- שומרת את הסיכום במערכת MongoDB (אם זמינה)
- מסמנת את השיחה כסוכמה כדי למנוע סיכום כפול

### 3. **הפעלה אוטומטית**
- המערכת מופעלת אוטומטית כשהשרת עולה
- רצה ברקע כחוט נפרד (daemon thread)
- לא מפריעה לפעילות הרגילה של הבוט

## 🚀 הפעלה

### הפעלה אוטומטית
המערכת מופעלת אוטומטית כשהשרת עולה:
```python
# ב-whatsapp_webhook.py
from auto_summarizer import start_auto_summarizer
start_auto_summarizer()
```

### הפעלה ידנית
```python
from auto_summarizer import start_auto_summarizer, stop_auto_summarizer

# הפעל
start_auto_summarizer()

# עצור
stop_auto_summarizer()
```

## 📊 פקודות מנהל

### בדיקת סטטוס
```
בדוק סיכום
summary status
מערכת סיכום
```

### שליטה במערכת
```
הפעל סיכום          # הפעל את המערכת
עצור סיכום          # עצור את המערכת
סכם הכל             # סיכום כפוי לכל השיחות הישנות
```

## ⚙️ הגדרות

### מרווח בדיקה
ברירת המחדל: בדיקה כל 5 דקות (300 שניות)
```python
auto_summarizer = AutoSummarizer(check_interval=300)
```

### זמן סיכום
ברירת המחדל: שעה (3600 שניות)
```python
if time_diff.total_seconds() > 3600:  # שעה
```

### מינימום הודעות לשיחה
ברירת המחדל: 5 הודעות
```python
if len(user_assistant_messages) < 5:
    continue
```

## 🔧 תכונות מתקדמות

### 1. **מניעת סיכום כפול**
- המערכת עוקבת אחרי שיחות שכבר סוכמו
- לא מבצעת סיכום כפול לאותה שיחה

### 2. **בדיקת סיכומים קיימים**
- בודקת אם יש כבר סיכום בקובץ הטקסט
- בודקת אם יש סיכום במערכת MongoDB
- מבצעת סיכום רק אם אין אחד קיים

### 3. **טיפול בשגיאות**
- ממשיכה לפעול גם אם יש שגיאה בשיחה ספציפית
- מתעדת שגיאות בלוג
- לא קורסת אם יש בעיה עם שיחה אחת

### 4. **גיבוי למערכת הישנה**
- אם המערכת החדשה לא עובדת, חוזרת לשיטה הישנה
- מבטיחה שהמערכת תמשיך לעבוד תמיד

## 📁 קבצים

### `auto_summarizer.py`
הקובץ הראשי של המערכת - מכיל את כל הלוגיקה

### `whatsapp_webhook.py`
מפעיל את המערכת כשהשרת עולה

### `chatbot.py`
משתמש במערכת החדשה במקום השיטה הישנה

## 🧪 בדיקה

### בדיקה ידנית
```bash
python auto_summarizer.py
```

### בדיקה דרך WhatsApp
שלח למנהל: "בדוק סיכום"

## 📈 יתרונות

1. **אוטומטי לחלוטין** - לא צריך לזכור לסכם שיחות
2. **לא מפספס שיחות** - כל שיחה מקבלת סיכום
3. **יעיל** - בודק רק שיחות פעילות
4. **אמין** - מניעת סיכום כפול
5. **גמיש** - אפשר לשנות הגדרות בקלות
6. **מנוטר** - מעקב אחרי סטטוס המערכת

## ⚠️ הערות חשובות

1. **זמן סיכום**: המערכת מחכה שעה שלמה לפני סיכום
2. **מינימום הודעות**: שיחה צריכה לפחות 5 הודעות כדי לקבל סיכום
3. **זיכרון**: המערכת שומרת במזכרון אילו שיחות כבר סוכמו
4. **ביצועים**: הבדיקה מתבצעת כל 5 דקות ולא מפריעה לבוט

## 🔮 עתיד

- אפשרות לשנות זמני סיכום לפי סוג לקוח
- התראות על שיחות שצריכות סיכום
- סטטיסטיקות מתקדמות על מערכת הסיכום
- אינטגרציה עם מערכות CRM חיצוניות
